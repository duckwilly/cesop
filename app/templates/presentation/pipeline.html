<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="description" content="Interactive demo of a CESOP compliance pipeline: from raw PSP payment data through cross-border filtering, error correction, and XML generation to official EU validation." />
    <title>CESOP Pipeline Studio</title>
    <link rel="stylesheet" href="{{ url_for('static', path='css/pipeline.css') }}" />
  </head>
  <body>
    <div class="page">
      <header class="hero" id="top">
        <div class="hero-content">
          <p class="kicker">End-to-end compliance</p>
          <h1>From raw payments to validated CESOP reports</h1>
          <p class="lede">
            Watch 10,000 payment records flow through the complete CESOP pipeline:
            cross-border filtering, threshold analysis, error correction, XML
            generation, and official EU validation. Every step is transparent,
            auditable, and production-ready.
          </p>
          <div class="hero-actions">
            <button class="btn primary" id="generateSample" type="button">
              <span class="btn-text">Generate 10k sample</span>
            </button>
            <button class="btn ghost" id="toggleCesopInfo" type="button">
              What's CESOP?
            </button>
          </div>
          <div class="hero-stats">
            <div class="stat">
              <div class="stat-label">Sample status</div>
              <div class="stat-value" id="sampleStatus">Not generated</div>
            </div>
            <div class="stat">
              <div class="stat-label">Rows</div>
              <div class="stat-value" id="sampleRows">10,000</div>
            </div>
            <div class="stat">
              <div class="stat-label">Estimated size</div>
              <div class="stat-value" id="sampleSize">~2.6 MB</div>
            </div>
          </div>
        </div>

        <div class="generator-card">
          <div class="card-header">
            <div>
              <p class="card-kicker">Sample generator</p>
              <h2>Realistic PSP data</h2>
            </div>
          </div>
          <div class="card-body">
            <div class="row">
              <span>Records</span>
              <strong>10,000 payments</strong>
            </div>
            <div class="row">
              <span>Reporting period</span>
              <strong>Q4 2025</strong>
            </div>
            <progress id="generatorProgress" value="0" max="100"></progress>
            <p class="generator-status" id="generatorStatus">
              Click to generate sample data.
            </p>
            <div class="note">
              Simulates a PSP licensed across multiple EU Member States.
              Includes realistic data quality issues to demonstrate
              error detection and correction capabilities.
            </div>
          </div>
        </div>
      </header>

      <div class="cesop-info" id="cesopInfo">
        <div class="cesop-info-inner">
          <div class="cesop-info-content">
            <h3>Central Electronic System of Payment Information</h3>
            <p>
              CESOP is an EU-wide system that collects payment data from Payment Service Providers
              to help tax authorities detect VAT fraud in e-commerce. Under the amended VAT Directive,
              PSPs must report cross-border payment data when a payee receives more than 25 payments
              in a calendar quarter.
            </p>
            <div class="cesop-info-details">
              <div class="cesop-info-block">
                <h4>Who reports</h4>
                <p>Payment Service Providers (banks, payment institutions, e-money issuers) licensed in the EU.</p>
              </div>
              <div class="cesop-info-block">
                <h4>What's reported</h4>
                <p>Cross-border payment transactions where the payee exceeds 25 payments per quarter per Member State.</p>
              </div>
              <div class="cesop-info-block">
                <h4>When</h4>
                <p>Quarterly submissions within one month after the end of each calendar quarter.</p>
              </div>
            </div>
            <a class="cesop-info-link" href="https://taxation-customs.ec.europa.eu/taxation/vat/fight-against-vat-fraud/tackling-vat-fraud-e-commerce-cesop_en" target="_blank" rel="noopener">
              Learn more on the EU CESOP portal
            </a>
          </div>
          <button class="cesop-info-close" id="closeCesopInfo" type="button" aria-label="Close">
            <svg width="20" height="20" viewBox="0 0 20 20" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M15 5L5 15M5 5l10 10"/>
            </svg>
          </button>
        </div>
      </div>

      <main class="pipeline">
        <section class="preview-dock" aria-label="Live data preview">
          <div class="panel preview-panel">
            <div class="panel-header">
              <div>
                <p class="panel-kicker">Live output</p>
                <h3 id="previewTitle">Raw Ingest</h3>
                <p class="panel-meta" id="previewMeta"></p>
              </div>
            </div>
            <pre id="previewCode" aria-live="polite"><span class="preview-content"></span></pre>
            <div class="metrics" id="previewMetrics"></div>
          </div>
        </section>

        <aside class="timeline">
          <div class="flow-card" id="flowCard">
            <p class="flow-title">Data funnel</p>
            <div class="flow-steps">
              <div class="flow-step" data-flow="raw">
                <span>Ingested</span>
                <strong id="flowTotal">10,000</strong>
                <div class="flow-bar"><div class="flow-bar-fill" id="flowTotalBar" style="width: 100%"></div></div>
              </div>
              <div class="flow-step" data-flow="cross-border">
                <span>Cross-border</span>
                <strong id="flowCrossBorder">8,200</strong>
                <div class="flow-bar"><div class="flow-bar-fill" id="flowCrossBorderBar" style="width: 82%"></div></div>
                <small id="flowExcluded">-1,800 excluded</small>
              </div>
              <div class="flow-step" data-flow="threshold">
                <span>&gt;25 / payee</span>
                <strong id="flowReportable">3,420</strong>
                <div class="flow-bar"><div class="flow-bar-fill" id="flowReportableBar" style="width: 34%"></div></div>
                <small id="flowBelowThreshold">-4,780 below threshold</small>
              </div>
              <div class="flow-step" data-flow="xml">
                <span>XML output</span>
                <strong id="flowXmlFiles">2 files</strong>
                <small id="flowMemberStates">6 reporting MS</small>
              </div>
            </div>
          </div>
          <div class="timeline-header">
            <h3>Pipeline</h3>
          </div>
          <ol class="timeline-list">
            <li class="timeline-item" data-step="raw">
              <button type="button">Raw Ingest</button>
            </li>
            <li class="timeline-item" data-step="cross-border">
              <button type="button">Cross-border Filter</button>
            </li>
            <li class="timeline-item" data-step="threshold">
              <button type="button">Threshold Gate</button>
            </li>
            <li class="timeline-item" data-step="errors">
              <button type="button">Error Detection</button>
            </li>
            <li class="timeline-item" data-step="corrected">
              <button type="button">Correction</button>
            </li>
            <li class="timeline-item" data-step="xml">
              <button type="button">XML Generation</button>
            </li>
            <li class="timeline-item" data-step="validation">
              <button type="button">Validation</button>
            </li>
          </ol>
          <div class="timeline-footer">
            <a href="#top" class="back-top">Back to top</a>
          </div>
        </aside>

        <div class="detail-grid">
          <section class="steps">
            <article class="step" id="step-raw" data-step="raw">
              <div class="step-head">
                <span class="step-index">01</span>
                <h2>Raw Ingest</h2>
                <p>
                  Load payment transaction data exactly as exported from the PSP's
                  core systems. No transformations yet, preserving raw values
                  for a complete audit trail.
                </p>
              </div>
              <div class="step-body">
                <div class="callout">
                  <h3>Source</h3>
                  <p>PSP transaction export with payment details, account identifiers, and location data.</p>
                </div>
                <div class="callout">
                  <h3>Principle</h3>
                  <p>Keep original values intact so every downstream change is traceable.</p>
                </div>
              </div>
            </article>

            <article class="step" id="step-cross-border" data-step="cross-border">
              <div class="step-head">
                <span class="step-index">02</span>
                <h2>Cross-border Filter</h2>
                <p>
                  CESOP only applies to cross-border payments. Domestic transactions
                  where payer and payee share the same Member State are filtered out.
                </p>
              </div>
              <div class="step-body">
                <div class="callout">
                  <h3>Rule</h3>
                  <p>Compare payer location against payee location per VAT Directive Art. 243b.</p>
                </div>
                <div class="callout">
                  <h3>Result</h3>
                  <p>Only cross-border transactions proceed to threshold analysis.</p>
                </div>
              </div>
            </article>

            <article class="step" id="step-threshold" data-step="threshold">
              <div class="step-head">
                <span class="step-index">03</span>
                <h2>Threshold Gate</h2>
                <p>
                  Reporting triggers when a payee receives more than 25 cross-border
                  payments in a quarter. This step identifies which payees and
                  Member States require reporting.
                </p>
              </div>
              <div class="step-body">
                <div class="callout">
                  <h3>Aggregation</h3>
                  <p>Count payments per payee per Member State within the quarter.</p>
                </div>
                <div class="callout">
                  <h3>Output</h3>
                  <p>Reportable payees identified, reporting jurisdictions determined.</p>
                </div>
              </div>
            </article>

            <article class="step" id="step-errors" data-step="errors">
              <div class="step-head">
                <span class="step-index">04</span>
                <h2>Error Detection</h2>
                <p>
                  Scan reportable records for data quality issues: invalid country
                  codes, malformed dates, non-standard currencies. Problems that
                  would fail validation are caught here.
                </p>
              </div>
              <div class="step-body">
                <div class="callout">
                  <h3>Validation</h3>
                  <p>Check against ISO code lists and CESOP schema requirements.</p>
                </div>
                <div class="callout">
                  <h3>Classification</h3>
                  <p>Flag issues by type and severity for targeted correction.</p>
                </div>
              </div>
            </article>

            <article class="step" id="step-corrected" data-step="corrected">
              <div class="step-head">
                <span class="step-index">05</span>
                <h2>Correction</h2>
                <p>
                  Apply deterministic repair rules to fix detected issues.
                  Every correction is logged as a diff, creating a complete
                  audit trail from original to corrected values.
                </p>
              </div>
              <div class="step-body">
                <div class="callout">
                  <h3>Transforms</h3>
                  <p>Normalize dates, standardize currency codes, fix location data.</p>
                </div>
                <div class="callout">
                  <h3>Transparency</h3>
                  <p>Before/after diffs preserved for compliance review.</p>
                </div>
              </div>
            </article>

            <article class="step" id="step-xml" data-step="xml">
              <div class="step-head">
                <span class="step-index">06</span>
                <h2>XML Generation</h2>
                <p>
                  Transform corrected records into CESOP PaymentData XML.
                  Proper namespaces, element ordering, and schema compliance
                  built in.
                </p>
              </div>
              <div class="step-body">
                <div class="callout">
                  <h3>Schema</h3>
                  <p>CESOP PaymentData v4.03 with correct namespace declarations.</p>
                </div>
                <div class="callout">
                  <h3>Files</h3>
                  <p>One XML file per reporting Member State per quarter.</p>
                </div>
              </div>
            </article>

            <article class="step" id="step-validation" data-step="validation">
              <div class="step-head">
                <span class="step-index">07</span>
                <h2>Validation</h2>
                <p>
                  Run generated XML through the official EU CESOP Validation Module.
                  Confirms schema compliance and business rule adherence before
                  submission to tax authorities.
                </p>
              </div>
              <div class="step-body">
                <div class="callout">
                  <h3>Official tool</h3>
                  <p>EU-provided validator checks structure and cross-field rules.</p>
                </div>
                <div class="callout">
                  <h3>Evidence</h3>
                  <p>Validation results stored alongside XML for audit trail.</p>
                </div>
              </div>
            </article>

            <article class="step" id="step-outro" data-step="outro">
              <div class="step-head">
                <span class="step-index">08</span>
                <h2>Complete</h2>
                <p>
                  Pipeline finished. Validated XML files are ready for submission
                  to Member State tax authorities via the CESOP portal.
                </p>
              </div>
              <div class="step-body">
                <div class="callout">
                  <h3>Deliverables</h3>
                  <p>Validated XML files, correction audit logs, validation reports.</p>
                </div>
                <div class="callout">
                  <h3>Source code</h3>
                  <p><a href="https://github.com/duckwilly/cesop">View on GitHub</a></p>
                </div>
              </div>
            </article>
          </section>

          <aside class="rules">
            <div class="panel rule-panel">
              <div class="panel-header">
                <div>
                  <p class="panel-kicker">Context</p>
                  <h3 id="ruleTitle"></h3>
                </div>
              </div>
              <p id="ruleBody"></p>
              <ul id="ruleList"></ul>
            </div>
          </aside>
        </div>
      </main>
    </div>
    <script src="{{ url_for('static', path='js/pipeline.js') }}"></script>
  </body>
</html>
