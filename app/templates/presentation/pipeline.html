<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>CESOP Pipeline Studio Prototype</title>
    <link rel="stylesheet" href="{{ url_for('static', path='css/pipeline.css') }}" />
  </head>
  <body>
    <div class="page">
      <header class="hero" id="top">
        <div class="hero-content">
          <p class="kicker">CESOP Pipeline Studio</p>
          <h1>Turn raw payments into validated CESOP XML, live.</h1>
          <p class="lede">
            A scroll-driven narrative that shows how a single, multi-license PSP
            turns raw exports into validated CESOP XML. We start with potentially
            reportable countries and end with the jurisdictions that actually
            require reporting. Designed for a portfolio demo that can later be
            wired to FastAPI + HTMX.
          </p>
          <div class="hero-actions">
            <button class="btn primary" id="generateSample" type="button">
              Generate 10k sample
            </button>
            <button class="btn ghost" id="replayPipeline" type="button">
              Replay pipeline
            </button>
          </div>
          <div class="hero-stats">
            <div class="stat">
              <div class="stat-label">Sample status</div>
              <div class="stat-value" id="sampleStatus">Not generated</div>
            </div>
            <div class="stat">
              <div class="stat-label">Rows</div>
              <div class="stat-value" id="sampleRows">10,000</div>
            </div>
            <div class="stat">
              <div class="stat-label">Estimated size</div>
              <div class="stat-value" id="sampleSize">~2.6 MB</div>
            </div>
          </div>
        </div>

        <div class="generator-card">
          <div class="card-header">
            <div>
              <p class="card-kicker">Live generator</p>
              <h2>Demo-sized data, real flow</h2>
            </div>
            <span class="pill" id="generatorBadge">Ready</span>
          </div>
          <div class="card-body">
            <div class="row">
              <span>Scale</span>
              <strong>10,000 rows</strong>
            </div>
            <div class="row">
              <span>Target quarter</span>
              <strong>Q4 2025</strong>
            </div>
            <div class="row">
              <span>Seed</span>
              <strong id="sampleSeed">--</strong>
            </div>
            <progress id="generatorProgress" value="0" max="100"></progress>
            <p class="generator-status" id="generatorStatus">
              Ready to generate a demo sample.
            </p>
            <div class="note">
              Scenario: one PSP licensed in multiple Member States. Generated
              data stays on the demo host and only includes synthetic values.
              Intended for live walk-throughs on regular devices.
            </div>
          </div>
        </div>
      </header>

      <main class="pipeline">
        <section class="preview-dock" aria-label="Live data preview">
          <div class="panel preview-panel">
            <div class="panel-header">
              <div>
                <p class="panel-kicker">Data preview</p>
                <h3 id="previewTitle">Raw Ingest</h3>
                <p class="panel-meta" id="previewMeta"></p>
              </div>
              <div class="panel-chips" id="previewChips"></div>
            </div>
            <pre id="previewCode" aria-live="polite"></pre>
            <div class="metrics" id="previewMetrics"></div>
          </div>
        </section>

        <aside class="timeline">
          <div class="flow-card" id="flowCard">
            <p class="flow-title">Record flow</p>
            <div class="flow-steps">
              <div class="flow-step" data-flow="raw">
                <span>Ingested</span>
                <strong id="flowTotal">10,000</strong>
              </div>
              <div class="flow-step" data-flow="cross-border">
                <span>Cross-border</span>
                <strong id="flowCrossBorder">8,200</strong>
                <small id="flowExcluded">-1,800 excluded</small>
              </div>
              <div class="flow-step" data-flow="threshold">
                <span>&gt;25 / payee</span>
                <strong id="flowReportable">3,420</strong>
                <small id="flowBelowThreshold">-4,780 below threshold</small>
              </div>
              <div class="flow-step" data-flow="xml">
                <span>XML output</span>
                <strong id="flowXmlFiles">2 files</strong>
                <small id="flowMemberStates">6 reporting MS</small>
              </div>
            </div>
          </div>
          <div class="timeline-header">
            <h3>Pipeline</h3>
            <p>Scroll to advance</p>
          </div>
          <ol class="timeline-list">
            <li class="timeline-item" data-step="raw">
              <button type="button">Raw Ingest</button>
            </li>
            <li class="timeline-item" data-step="cross-border">
              <button type="button">Cross-border filter</button>
            </li>
            <li class="timeline-item" data-step="threshold">
              <button type="button">Threshold gate</button>
            </li>
            <li class="timeline-item" data-step="errors">
              <button type="button">Error Detection</button>
            </li>
            <li class="timeline-item" data-step="corrected">
              <button type="button">Correction</button>
            </li>
            <li class="timeline-item" data-step="xml">
              <button type="button">XML Generation</button>
            </li>
            <li class="timeline-item" data-step="validation">
              <button type="button">Validation</button>
            </li>
          </ol>
          <div class="timeline-footer">
            <a href="#top" class="back-top">Back to top</a>
          </div>
        </aside>

        <div class="detail-grid">
          <section class="steps">
            <article class="step" id="step-raw" data-step="raw">
              <div class="step-head">
                <span class="step-index">01</span>
                <h2>Raw Ingest</h2>
                <p>
                  Load a single PSP export plus its licensed Member State
                  footprint. Capture source context, reporting period, and
                  payment metadata before applying any rules.
                </p>
              </div>
              <div class="step-body">
                <div class="callout">
                  <h3>Inputs</h3>
                  <p>CSV rows, licensed Member States, and payee PSPs for remittance flows.</p>
                </div>
                <div class="callout">
                  <h3>Focus</h3>
                  <p>Preserve raw values to make later corrections auditable.</p>
                </div>
              </div>
            </article>

            <article class="step" id="step-cross-border" data-step="cross-border">
              <div class="step-head">
                <span class="step-index">02</span>
                <h2>Cross-border Filter</h2>
                <p>
                  Keep only cross-border payments. Transactions where payer and
                  payee are in the same Member State are excluded from CESOP
                  reporting.
                </p>
              </div>
              <div class="step-body">
                <div class="callout">
                  <h3>Filter</h3>
                  <p>Compare payer and payee locations per Art. 243b.</p>
                </div>
                <div class="callout">
                  <h3>Output</h3>
                  <p>Cross-border subset ready for threshold checks.</p>
                </div>
              </div>
            </article>

            <article class="step" id="step-threshold" data-step="threshold">
              <div class="step-head">
                <span class="step-index">03</span>
                <h2>Threshold Gate</h2>
                <p>
                  Apply the &gt;25 rule per payee and Member State for the quarter.
                  Only payees above the threshold move forward, and we learn which
                  Member States actually require reporting.
                </p>
              </div>
              <div class="step-body">
                <div class="callout">
                  <h3>Aggregation</h3>
                  <p>Count per payee and payee Member State.</p>
                </div>
                <div class="callout">
                  <h3>Result</h3>
                  <p>Reportable transactions and reporting MS are isolated.</p>
                </div>
              </div>
            </article>

            <article class="step" id="step-errors" data-step="errors">
              <div class="step-head">
                <span class="step-index">04</span>
                <h2>Error Detection</h2>
                <p>
                  Identify missing identifiers, invalid country codes, and
                  formatting issues that would break schema or business rules.
                </p>
              </div>
              <div class="step-body">
                <div class="callout">
                  <h3>Signal</h3>
                  <p>Surface issues early with severity and volume.</p>
                </div>
                <div class="callout">
                  <h3>Output</h3>
                  <p>Tagged records to route into correction logic.</p>
                </div>
              </div>
            </article>

            <article class="step" id="step-corrected" data-step="corrected">
              <div class="step-head">
                <span class="step-index">05</span>
                <h2>Correction</h2>
                <p>
                  Apply normalization and repair rules. Capture every change as a
                  diff so the correction story is explainable.
                </p>
              </div>
              <div class="step-body">
                <div class="callout">
                  <h3>Rules</h3>
                  <p>Format dates, normalize currencies, validate IDs.</p>
                </div>
                <div class="callout">
                  <h3>Audit</h3>
                  <p>Keep before and after values for reporting.</p>
                </div>
              </div>
            </article>

            <article class="step" id="step-xml" data-step="xml">
              <div class="step-head">
                <span class="step-index">06</span>
                <h2>XML Generation</h2>
                <p>
                  Map normalized fields into CESOP PaymentData XML with the right
                  namespaces, ordering, and schema version.
                </p>
              </div>
              <div class="step-body">
                <div class="callout">
                  <h3>Mapping</h3>
                  <p>Translate CSV columns to schema nodes.</p>
                </div>
                <div class="callout">
                  <h3>Output</h3>
                  <p>One file per licensed Member State and quarter.</p>
                </div>
              </div>
            </article>

            <article class="step" id="step-validation" data-step="validation">
              <div class="step-head">
                <span class="step-index">07</span>
                <h2>Validation</h2>
                <p>
                  Run the official CESOP Validation Module to confirm structure
                  and business rules before submission.
                </p>
              </div>
              <div class="step-body">
                <div class="callout">
                  <h3>Checks</h3>
                  <p>Schema compliance plus cross-field validation.</p>
                </div>
                <div class="callout">
                  <h3>Proof</h3>
                  <p>Keep validation XML for audit and demos.</p>
                </div>
              </div>
            </article>

            <article class="step" id="step-outro" data-step="outro">
              <div class="step-head">
                <span class="step-index">08</span>
                <h2>Outro</h2>
                <p>
                  Wrap the story, hand off the artifacts, and point to the next
                  destination for the demo.
                </p>
              </div>
              <div class="step-body">
                <div class="callout">
                  <h3>Return</h3>
                  <p><a href="#top">Back to main website</a></p>
                </div>
                <div class="callout">
                  <h3>Project</h3>
                  <p><a href="https://github.com/duckwilly/cesop">View on GitHub</a></p>
                </div>
              </div>
            </article>
          </section>

          <aside class="rules">
            <div class="panel rule-panel">
              <div class="panel-header">
                <div>
                  <p class="panel-kicker">Rule focus</p>
                  <h3 id="ruleTitle"></h3>
                </div>
                <span class="pill">CESOP</span>
              </div>
              <p id="ruleBody"></p>
              <ul id="ruleList"></ul>
              <a class="rule-link" href="{{ url_for('docs', path='business_rules.md') }}" id="ruleLink">
                Review full rule catalog
              </a>
            </div>
          </aside>
        </div>
      </main>
    </div>
    <script src="{{ url_for('static', path='js/pipeline.js') }}"></script>
  </body>
</html>
