# CESOP CSV -> XML Mapping (v6.00)

This document maps the generator CSV fields to CESOP PaymentData XML elements
based on `schemas/v6_00/PaymentData.xsd`, `commontypes.xsd`, and `isotypes.xsd`.
It is a working guide for the first valid XML export.

## Spec references
- `schemas/v6_00/PaymentData.xsd`: `CESOP`, `MessageSpec_Type`, `PaymentDataBody_Type`,
  `ReportedPayee_Type`, `ReportedTransaction_Type`.
- `schemas/v6_00/commontypes.xsd`: `Name_Type`/`NameType_EnumType`, `Amount_Type`,
  `PaymentMethod_Type`, `TransactionDate_Type`, `DocSpec_Type`, `AccountIdentifier_Type`.
- `schemas/v6_00/isotypes.xsd`: `MSCountryCode_Type`, `CountryCode_Type`, `currCode_Type`.
- `docs/business_rules.md`: Directive + implementing regulation summary.

## Inputs
Source: `data/synthetic/*.csv` generated by `cesop-demo generate`.

## Output target
XML root: `<CESOP>` (namespace `urn:ec.europa.eu:taxud:fiscalis:cesop:v1`)
with attribute `version="4.03"` (fixed in the XSD).

## Transformation rules (core)
1. Only include cross-border payments where the payer is in the EU and the
   payee is in a different Member State or third country (payee country derived
   from the payee identifier per Art. 243c).
2. Bucket by calendar quarter and year.
3. Threshold rule: for each payee location (Member State/country) and identifier,
   include only payees with `count > 25` cross-border payments in the quarter.
   If a payee has multiple identifiers known to the PSP, aggregate per payee.
4. Emit a single PaymentData message per quarter.

## MessageSpec (header)
| XML Element | Source | Notes |
| --- | --- | --- |
| `MessageSpec/TransmittingCountry` | derived/constant | Member State of tax administration (default `auto`, derived from PSP BIC; override via CLI). |
| `MessageSpec/MessageType` | constant | `PMT`. |
| `MessageSpec/MessageTypeIndic` | constant | `CESOP100` (new data). |
| `MessageSpec/MessageRefId` | generated | UUID v4. |
| `MessageSpec/ReportingPeriod/Quarter` | derived | Quarter from `execution_time` (1-4). |
| `MessageSpec/ReportingPeriod/Year` | derived | Year from `execution_time`. |
| `MessageSpec/Timestamp` | generated | Current UTC timestamp with timezone. |

## ReportingPSP
| XML Element | Source | Notes |
| --- | --- | --- |
| `PaymentDataBody/ReportingPSP/PSPId` | `psp_id` | Attribute `PSPIdType="BIC"` (default). |
| `PaymentDataBody/ReportingPSP/Name` | `psp_name` | `nameType="BUSINESS"`. |

`psp_id`/`psp_name` always refer to the reporting PSP. `payee_psp_id` and
`payee_psp_name` are used to decide whether the reporting PSP is acting for the
payer or the payee (payer PSPs skip reporting when the payee PSP is in the EU).

## ReportedPayee (grouped by payee_id)
| XML Element | Source | Notes |
| --- | --- | --- |
| `ReportedPayee/Name` | `payee_name` | `nameType="BUSINESS"`. |
| `ReportedPayee/Country` | derived | From payee account identifier; if no account, payee PSP BIC (ISO-3166 alpha-2). |
| `ReportedPayee/Address` | derived | Use `AddressFree` if available. |
| `ReportedPayee/EmailAddress` | `payee_email` | Optional. |
| `ReportedPayee/WebPage` | `payee_web` | Optional. |
| `ReportedPayee/TAXIdentification` | `payee_tax_id`, `payee_vat_id` | Include empty element if none (allowed by XSD). |
| `ReportedPayee/TAXIdentification/VATId/@issuedBy` | `payee_country` | Required by `VATId_Type` (MS country). |
| `ReportedPayee/TAXIdentification/TAXId/@issuedBy` | `payee_country` | Required by `TAXId_Type` (country). |
| `ReportedPayee/TAXIdentification/TAXId/@type` | constant | `TIN` (required by `TAXId_Type`). |
| `ReportedPayee/AccountIdentifier` | `payee_account` | Emit allowed identifier sets (single account, or account+BIC pair); attributes: `type=payee_account_type`, `CountryCode=payee_country`, and `accountIdentifierOther` when `type=Other`. |
| `ReportedPayee/Representative` | `payee_psp_id`, `payee_psp_name` | Required only when the payee receives funds without a payment account. Uses `RepresentativeId` with `PSPIdType="BIC"`. |
| `ReportedPayee/DocSpec/DocTypeIndic` | constant | `CESOP1` (new data). |
| `ReportedPayee/DocSpec/DocRefId` | generated | UUID v4. |

### Address mapping
Use `cm:AddressFree` (from `commontypes.xsd`) if any of `payee_address_line`,
`payee_city`, or `payee_postcode` is present. Suggested format:
`"{payee_address_line}, {payee_postcode} {payee_city}"`.

### DocSpec mapping
`DocSpec` uses `cm:DocTypeIndic` and `cm:DocRefId` elements defined in
`commontypes.xsd`.

### PaymentMethod mapping
`PaymentMethod` uses `cm:PaymentMethodType` (and optional
`cm:PaymentMethodOther`) defined in `commontypes.xsd`.

### Account identifier sets
CESOP validation allows only a **single** `IBAN`/`OBAN`/`Other` identifier per
payee, or a paired account + `BIC`. When multiple identifiers appear in the
input CSV, the XML output selects a primary account (IBAN > OBAN > Other) and
adds one optional `BIC` if present.

## ReportedTransaction (per payment)
| XML Element | Source | Notes |
| --- | --- | --- |
| `ReportedTransaction/@IsRefund` | `is_refund` | Boolean attribute, default `false`. |
| `ReportedTransaction/TransactionIdentifier` | `payment_id` | Unique per payment. |
| `ReportedTransaction/CorrTransactionIdentifier` | `corr_payment_id` | Only when refund. |
| `ReportedTransaction/DateTime` | `execution_time` | Must include timezone. Attribute `transactionDateType="CESOP701"` (Execution Date). |
| `ReportedTransaction/Amount` | `amount` | Two decimals, with `currency` attribute. |
| `ReportedTransaction/Amount` | `amount` | Refunds must be negative when `IsRefund=true`. |
| `ReportedTransaction/PaymentMethod/PaymentMethodType` | `payment_method` | Must match XSD enum. |
| `ReportedTransaction/InitiatedAtPhysicalPremisesOfMerchant` | `initiated_at_pos` | Boolean. |
| `ReportedTransaction/PayerMS` | `payer_country` | Attribute `PayerMSSource=payer_ms_source`. |

## Defaults and constants
- `PSPIdType`: `BIC` (unless a different type is provided later).
- `nameType`: `BUSINESS` for both PSP and payee names.
- `MessageTypeIndic`: `CESOP100`.
- `DocTypeIndic`: `CESOP1`.

## Validation considerations
- Respect element order exactly as defined in XSD.
- Required elements must be present even if empty (e.g., `TAXIdentification`).
- `Amount` must match `-?[0-9]*\.[0-9]{2}` and carry a valid ISO-4217 currency.
- `Timestamp` and `DateTime` must include timezone.

## Open items
- Decide if quarter/year come from CLI flags or derived from `execution_time`.
